客服系统基于 WebSocket 实现

为了更好的开发，这里约定几个事实标准：

### 1. 所有的 WebSocket 帧都为 JSON

无论是客服端发出的，还是收到帧。并且都满足以下格式

客户端发出的消息，必须满足以下格式：

| 字段    | 类型     | 说明                                        | 必填 |
| ------- | -------- | ------------------------------------------- | ---- |
| id      | `string` | 消息的 ID，客户端需要自行生成，用于识别回复 | \*   |
| to      | `string` | 这条消息发给谁，**只有客服需要传这个字段**  |      |
| type    | `string` | 消息类型，下面见详情                        | \*   |
| payload | `any`    | 消息的的附带数据                            |      |

客户端接收到的消息满足以下格式：

| 字段     | 类型     | 说明                                                                     | 必填 |
| -------- | -------- | ------------------------------------------------------------------------ | ---- |
| id       | `string` | 这条消息本身的 ID                                                        | \*   |
| from     | `string` | 这条消息来自哪里，**发送不需要这个字段，但是返回的消息可能带有这个字段** |      |
| to       | `string` | 这条消息发给谁，**只有客服需要传这个字段**                               | \*   |
| type     | `string` | 消息类型，下面见详情                                                     | \*   |
| payload  | `any`    | 消息的的附带数据                                                         |      |
| reply_id | `string` | 这条消息是针对某一条消息(对应的 ID )的回复                               |      |

### 2. 连接流程

#### `用户端` 的连接流程 `ws://localhost/v1/ws/user/connect`

1 - 连接 WebSocket

2 - 收到来自服务端的推送 `{"to":"你的 UUID","type":"initialize"}`

3 - 发送数据体 `{"type": "auth", payload: { "token": "your token" }}` 给服务器进行身份认证

4 - 发送数据体 `{"type": "connect"}` 给服务器请求连接

5 - 收到来自服务器的推送 `{"to":"你的 UUID","type":"connect_success","payload":{"uuid":"对方的 UUID"}}` 表示和客服连接成功

6 - 发送数据 `{"type":"message_text","payload":{"message":"你好，这是一条信息!"}}` 用于发送信息给客服

7 - 客服主动与你断开连接，收到来自服务器的推送 `{"from":"对方的 UUID","to":"你的UUID","type":"disconnected"}`

#### `客服端` 的连接流程 `ws://localhost/v1/ws/waiter/connect`

1 - 连接 WebSocket

2 - 收到来自服务端的推送 `{"to":"你的UUID","type":"initialize"}`

3 - 发送数据体 `{"type": "auth", payload: { "token": "your token" }}` 给服务器进行身份认证

4 - 发送数据体 `{"type": "ready"}` 给服务器表示客服已准备就绪，可以连接用户

5 - 收到来自服务器的推送 `{"to":"你的 UUID","type":"new_connection","payload":{"uuid":"用户的 UUID"}}` 表示和新的用户建立连接

6 - 发送数据 `{"to": "用户的 UUID","type":"message_text","payload":{"message":"你好，这是一条信息!"}}` 用于发送信息给用户

6 - 用户主动与你断开连接，收到来自服务器的推送 `{"from":"用户的 UUID","to":"你的 UUID","type":"disconnected"}`

### 消息类型 type

消息类型定义了 **你允许发送什么类型的消息** 和 **你会收到什么类型的消息**

#### 用户端可以发出的消息类型

| Type         | 说明                                     | 对应的 Payload                |
| ------------ | ---------------------------------------- | ----------------------------- |
| connect      | 请求连接一个客服                         | `null`                        |
| message_text | 发送消息文本给客服，**需要先连接到客服** | `{"message": "这是一条消息"}` |

#### 用户端会收到的消息类型

| Type            | 说明                            | 对应的 Payload                |
| --------------- | ------------------------------- | ----------------------------- |
| initialize      | 连接初始化                      | `null`                        |
| connect_success | 连接客服成功                    | `{"uuid": "客服的 UUID"}`     |
| disconnected    | 客服主动断开连接                | `null`                        |
| connect_queue   | 请求连接客服，但是正忙,正在排队 | `{"location": 100}`           |
| message_text    | 收到来自客服的消息              | `{"message": "这是一条消息"}` |
| error           | 操作错误                        | `{"message": "这是错误信息"}` |

#### 客服端可以发出的消息类型

| Type         | 说明                                     | 对应的 Payload                |
| ------------ | ---------------------------------------- | ----------------------------- |
| ready        | 客服已就绪，可以连接客户                 | `null`                        |
| message_text | 发送消息文本给用户, **需要指定 to 字段** | `{"message": "这是一条消息"}` |

#### 客服端会收到的消息类型

| Type           | 说明                 | 对应的 Payload                |
| -------------- | -------------------- | ----------------------------- |
| initialize     | 连接初始化           | `null`                        |
| new_connection | 有新的用户与客服连接 | `{"uuid": "用户的 UUID"}`     |
| disconnected   | 用户主动与客服断开   | `null`                        |
| message_text   | 收到来自用户的消息   | `{"message": "这是一条消息"}` |
| error          | 操作错误             | `{"message": "这是错误信息"}` |
